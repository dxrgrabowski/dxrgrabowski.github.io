<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="PrefaceIn the first article, you could see that the simple program: 1int main() &#123; return 1; &#125; Was 15776 bytes in size when dynamically linked and 900224 bytes in size when statically linked.">
<meta property="og:type" content="article">
<meta property="og:title" content="The Art of Creating Minimal ELF64 Executables by Unconventional Methods">
<meta property="og:url" content="http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/index.html">
<meta property="og:site_name" content="Dawid Grabowski&#39;s Blog">
<meta property="og:description" content="PrefaceIn the first article, you could see that the simple program: 1int main() &#123; return 1; &#125; Was 15776 bytes in size when dynamically linked and 900224 bytes in size when statically linked.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/hexyl-before.png">
<meta property="og:image" content="http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/hexyl-after.png">
<meta property="og:image" content="http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/hexyl-noalign.png">
<meta property="og:image" content="http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/hexyl-noalign-instruction.png">
<meta property="og:image" content="http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/hexyl-noalign-instruction-embed.png">
<meta property="article:published_time" content="2024-09-27T11:03:04.000Z">
<meta property="article:modified_time" content="2024-10-25T18:03:07.166Z">
<meta property="article:author" content="Dawid Grabowski">
<meta property="article:tag" content="assembly">
<meta property="article:tag" content="linker">
<meta property="article:tag" content="libc">
<meta property="article:tag" content="gcc">
<meta property="article:tag" content="process">
<meta property="article:tag" content="executable format">
<meta property="article:tag" content="elf64">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/hexyl-before.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/DXR_cut_rounded.png">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/DXR_cut_rounded.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/DXR_cut_rounded.png">
        
      
    
    <!-- title -->
    <title>The Art of Creating Minimal ELF64 Executables by Unconventional Methods</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-M1CMTMN59L"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-M1CMTMN59L');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/dxrgrabowski">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/09/17/2-syscalls-asm-glibc/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&text=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&title=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&is_video=false&description=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=The Art of Creating Minimal ELF64 Executables by Unconventional Methods&body=Check out this article: http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&title=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&title=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&title=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&title=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&name=The Art of Creating Minimal ELF64 Executables by Unconventional Methods&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&t=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Preface"><span class="toc-number">1.</span> <span class="toc-text">Preface</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#C-specifics"><span class="toc-number">1.1.</span> <span class="toc-text">C specifics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Glibc"><span class="toc-number">1.2.</span> <span class="toc-text">Glibc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-this-could-differ-to-other-pc"><span class="toc-number">1.3.</span> <span class="toc-text">How this could differ to other pc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Intel-vs-AT-T-syntax"><span class="toc-number">1.4.</span> <span class="toc-text">Intel vs AT&amp;T syntax</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-steps-we-can-make-in-C-to-reduce-file-size"><span class="toc-number">2.</span> <span class="toc-text">What steps we can make in C to reduce file size</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Assembly"><span class="toc-number">3.</span> <span class="toc-text">Assembly</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memory-Alignment-in-Sections-and-Segments"><span class="toc-number">4.</span> <span class="toc-text">Memory Alignment in Sections and Segments</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Modifying-and-removing-alignment"><span class="toc-number">4.1.</span> <span class="toc-text">Modifying and removing alignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Custom-linker-script"><span class="toc-number">4.2.</span> <span class="toc-text">Custom linker script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shstrtab"><span class="toc-number">4.3.</span> <span class="toc-text">.shstrtab</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-do-we-need-sections-per-se-then-let%E2%80%99s-try-to-have-some-fun"><span class="toc-number">5.</span> <span class="toc-text">Why do we need sections per se then, let’s try to have some fun.</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ELF64-Before"><span class="toc-number">5.1.</span> <span class="toc-text">ELF64 Before</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EHDR-fields-needed-for-modification"><span class="toc-number">5.2.</span> <span class="toc-text">EHDR fields needed for modification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHDR-fields-needed-for-modification"><span class="toc-number">5.3.</span> <span class="toc-text">PHDR fields needed for modification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Final-result"><span class="toc-number">5.4.</span> <span class="toc-text">Final result</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Removing-alignment"><span class="toc-number">5.5.</span> <span class="toc-text">Removing alignment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reducing-instruction-size"><span class="toc-number">6.</span> <span class="toc-text">Reducing instruction size</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Embedding-the-Code-in-the-ELF-Header"><span class="toc-number">7.</span> <span class="toc-text">Embedding the Code in the ELF Header</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">8.</span> <span class="toc-text">Conclusion</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#During-the-writing-thoughts"><span class="toc-number">8.1.</span> <span class="toc-text">During the writing thoughts</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-next"><span class="toc-number">9.</span> <span class="toc-text">What next?</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        The Art of Creating Minimal ELF64 Executables by Unconventional Methods
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Dawid Grabowski</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-09-27T11:03:04.000Z" class="dt-published" itemprop="datePublished">2024-09-27</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/assembly/" rel="tag">assembly</a>, <a class="p-category" href="/tags/elf64/" rel="tag">elf64</a>, <a class="p-category" href="/tags/executable-format/" rel="tag">executable format</a>, <a class="p-category" href="/tags/gcc/" rel="tag">gcc</a>, <a class="p-category" href="/tags/libc/" rel="tag">libc</a>, <a class="p-category" href="/tags/linker/" rel="tag">linker</a>, <a class="p-category" href="/tags/process/" rel="tag">process</a>
    </div>


    </div>
    <span class="word-count"></span>
    <span class="reading-time"></span>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>In the first article, you could see that the simple program:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>Was 15776 bytes in size when dynamically linked and 900224 bytes in size when statically linked. Although on today’s computers, these values ​​do not make any impression, still it is surprising that a program that theoretically has several instructions weighs so much. This article delves into the techniques for creating extremely tiny ELF64 (Executable and Linkable Format 64bit) executables on Linux systems.</p>
<h3 id="C-specifics"><a href="#C-specifics" class="headerlink" title="C specifics"></a>C specifics</h3><p>Unfortunately, in the case of C, the options are quite limited. At some point, we would conclude that it would actually be best to do inline assembly, start the function with _start, and compile with flag -nostdlib and -nostartfiles. For such an application, we could use a lighter library adapted to embedded systems. Like <a target="_blank" rel="noopener" href="https://uclibc-ng.org/">uClibc</a>, written for a very limited Linux without MMU or other libraries typically for microcontrollers, such as <a target="_blank" rel="noopener" href="https://sourceware.org/newlib/">newlib</a> or its descendant <a target="_blank" rel="noopener" href="https://github.com/picolibc/picolibc">picolibc</a>, it still won’t get us as close to a minimal elf64 as asm. </p>
<h3 id="Glibc"><a href="#Glibc" class="headerlink" title="Glibc"></a>Glibc</h3><p>Today, glibc is used in most cases, because most Linux distros contain it. But it wasn’t always like that, Debian used eglibc in the years 2009-2015. The situation was mainly due to the organizational structure of glibc and the fact that it was considered insufficiently adapted to embedded systems or ARM. <a target="_blank" rel="noopener" href="https://ecos.sourceware.org/ml/libc-alpha/2002-01/msg00079.html">Here</a> is the correspondence where Linus complains about glibc and calls it “bloated”. I will briefly present the procedure in the case of C and as soon as possible slide into our beloved Assembly.</p>
<h3 id="How-this-could-differ-to-other-pc"><a href="#How-this-could-differ-to-other-pc" class="headerlink" title="How this could differ to other pc"></a>How this could differ to other pc</h3><p>As the number of executed instructions could be relatively deterministic, the size of the elf file will be very dependent on the machine, installed library versions, and other factors. Of course, going lower and lower with values between different machines, at some point the values will start to be the same, as we get rid of some external dependencies.</p>
<h3 id="Intel-vs-AT-T-syntax"><a href="#Intel-vs-AT-T-syntax" class="headerlink" title="Intel vs AT&amp;T syntax"></a>Intel vs AT&amp;T syntax</h3><p>At the very beginning, I will state that Assembly has two syntaxes AT&amp;T and Intel, they are completely incompatible, the order of operands, register prefixes, and number prefixes are different. I will use Intel to be compatible with nasm.</p>
<h2 id="What-steps-we-can-make-in-C-to-reduce-file-size"><a href="#What-steps-we-can-make-in-C-to-reduce-file-size" class="headerlink" title="What steps we can make in C to reduce file size"></a>What steps we can make in C to reduce file size</h2><p>The obvious first step is stripping the executable by adding <code>-s</code> which in our case will remove sections containing symbols .strtab and .symtab which are not needed in execution. After this step <code>-flto</code> will do nothing same as optimizations. The next possible move is to use <code>-Wl,--gc-sections</code> which is just a garbage collector but for sections during the linking process.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-rwxr-xr-x <span class="number">1</span> dxr dxr <span class="number">15776</span> default       <span class="comment">// gcc -o default main.c </span></span><br><span class="line">-rwxr-xr-x <span class="number">1</span> dxr dxr <span class="number">15744</span> flto          <span class="comment">// -flto</span></span><br><span class="line">-rwxr-xr-x <span class="number">1</span> dxr dxr <span class="number">14328</span> stripped      <span class="comment">// strip --strip-all default</span></span><br><span class="line">-rwxr-xr-x <span class="number">1</span> dxr dxr <span class="number">14328</span> s             <span class="comment">// -s</span></span><br><span class="line">-rwxr-xr-x <span class="number">1</span> dxr dxr <span class="number">14328</span> s-o3          <span class="comment">// -s -o3</span></span><br><span class="line">-rwxr-xr-x <span class="number">1</span> dxr dxr <span class="number">14328</span> s-o3-flto     </span><br><span class="line">-rwxr-xr-x <span class="number">1</span> dxr dxr <span class="number">14248</span> s-o3-flto-gc  <span class="comment">// -s -o3 -flto -Wl,--gc-sections</span></span><br></pre></td></tr></table></figure>
<p>These are the simplest techniques, without interfering too much with the program. From a certain point on, it starts to be more of a fight for bytes than writing a program; therefore, if someone is fighting such a fight, it is rather certainly already in Assembly, which we will also do below. For the curious, the next steps without inline asm would be to try to link object files with libraries and disable paging. Also removing unnecessary sections, which would be removed for us by a custom linker script, which would also combine all sections and make one segment.</p>
<h2 id="Assembly"><a href="#Assembly" class="headerlink" title="Assembly"></a>Assembly</h2><p>We will jump straight to assembling with nasm and linking with ld to speed up a little. </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">section .text</span><br><span class="line">    global _start</span><br><span class="line"></span><br><span class="line">_start<span class="punctuation">:</span></span><br><span class="line">    mov rax<span class="punctuation">,</span> <span class="number">60</span>    </span><br><span class="line">    mov rdi<span class="punctuation">,</span> <span class="number">1</span>      </span><br><span class="line">    syscall</span><br></pre></td></tr></table></figure>
<p>after calling <code>nasm -f elf64 small.asm</code> and  <code>ld -s small.o</code> we get:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rwxr-xr-x <span class="number">1</span> dxr dxr <span class="number">4320</span> a.out</span><br></pre></td></tr></table></figure>
<p>4320 bytes is a lot for such a small program, especially in asm without library overhead. In the above case, we are using 64 bit registers, changing to ax and di, i.e. 16-bit registers instead of 64-bit rax and rdi, does not make any difference in the output file a.out. Even though by calling <code>objdump -x a.out</code> we can see that the size of the .text section decreases from 12 to 10 bytes. This is because the sections are aligned to 16 bytes &#x3D;&#x3D; 2**4</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Sections<span class="punctuation">:</span></span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">  <span class="number">0</span> .text         <span class="number">0000000</span>c  <span class="number">0000000000401000</span>  <span class="number">0000000000401000</span>  <span class="number">00001000</span>  <span class="number">2</span>**<span class="number">4</span></span><br><span class="line">                     /\</span><br><span class="line">                     /\</span><br><span class="line">  this value decreases but exe file size does not shrink</span><br></pre></td></tr></table></figure>
<h2 id="Memory-Alignment-in-Sections-and-Segments"><a href="#Memory-Alignment-in-Sections-and-Segments" class="headerlink" title="Memory Alignment in Sections and Segments"></a>Memory Alignment in Sections and Segments</h2><p>This is because the sections are aligned to 16 bytes &#x3D;&#x3D; 2<strong>4. This means that it doesn’t matter if the value is 2, 12 or 15, this section will have the same size. You may immediately wonder why it is constructed this way and why 2</strong>4 and 2**12, well, read further.</p>
<p>Let’s look at <code>readelf -lSW a.out</code> it, will show a little bit more info:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Section Headers<span class="punctuation">:</span></span><br><span class="line">  <span class="punctuation">[</span>Nr<span class="punctuation">]</span> Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  <span class="punctuation">[</span> <span class="number">0</span><span class="punctuation">]</span>                   NULL            <span class="number">0000000000000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  <span class="punctuation">[</span> <span class="number">1</span><span class="punctuation">]</span> .text             PROGBITS        <span class="number">0000000000401000</span> <span class="number">001000</span> <span class="number">000009</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  <span class="punctuation">[</span> <span class="number">2</span><span class="punctuation">]</span> .shstrtab         STRTAB          <span class="number">0000000000000000</span> <span class="number">001009</span> <span class="number">000011</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">Key to Flags<span class="punctuation">:</span></span><br><span class="line">  A (alloc)<span class="punctuation">,</span> X (execute)</span><br><span class="line"></span><br><span class="line">Elf file type is EXEC (Executable file)</span><br><span class="line">Entry point <span class="number">0x401000</span></span><br><span class="line">There are <span class="number">2</span> program headers<span class="punctuation">,</span> starting at offset <span class="number">64</span></span><br><span class="line"></span><br><span class="line">Program Headers<span class="punctuation">:</span></span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  LOAD           <span class="number">0x000000</span> <span class="number">0x0000000000400000</span> <span class="number">0x0000000000400000</span> <span class="number">0x0000b0</span> <span class="number">0x0000b0</span> R   <span class="number">0x1000</span></span><br><span class="line">  LOAD           <span class="number">0x001000</span> <span class="number">0x0000000000401000</span> <span class="number">0x0000000000401000</span> <span class="number">0x000009</span> <span class="number">0x000009</span> R E <span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line"> Section to Segment mapping<span class="punctuation">:</span></span><br><span class="line">  Segment Sections...</span><br><span class="line">   <span class="number">00</span></span><br><span class="line">   <span class="number">01</span>     .text</span><br></pre></td></tr></table></figure>
<p>We see two memory segments typed LOAD, which are intended to be loaded into memory once memory is allocated for them. </p>
<p>The first one is <span class="reveal-text" before="0xB0" after="176 bytes"></span>. Which mostly holds the ELF header. It will allow the system to identify that it is an elf file or go to the entry point address and the program header, which will be used immediately after to allocate memory space for the segments.</p>
<p>The second is 9 bytes, which is .text (code) section. Mapped to a segment with 2**12 alignment. We can also see that in addition to the R (READ) flag, there is also an E (Execute) which, together with the fact that the Entry point holds its address and Section to Segment mapping, confirms that this is the code. </p>
<p>Segments are mapped with 2**12 tonicity, which is a typical 4096 bytes, which is used for paging virtual memory (RAM). It is ideal to choose a value that fits within the page boundaries. Even if there is a bit too much memory redundancy to achieve maximum speed.</p>
<p>Sections are mapped to segments only for the purpose of loading into memory. Sections and their information are more important to the processor itself, they are made to organize code and data. The .text (code) section will certainly be used very intensively, i.e. it will be placed as close to the CPU as possible. These will be cache memories, which are often paged by 16 bytes. It could also be 4, 8, or 32, but picking the value 16 is a typical alignment on x86_64. It will also mean less memory usage and space savings. The cache memory is valuable, and its optimal use is very significant.</p>
<h3 id="Modifying-and-removing-alignment"><a href="#Modifying-and-removing-alignment" class="headerlink" title="Modifying and removing alignment"></a>Modifying and removing alignment</h3><p>Linker set the default alignment to 1000 for segments. By calling <code>ld -z max-page-size=0x1 -s small.o</code> we can manipulate this value. But still, the best solution would be to get rid of page alignment altogether. This will provide us with the <code>-n / -nmagic</code> option of calling it combined with strip <code>ld -n -s</code> we get such executable (reduced for clarity):</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Section Headers<span class="punctuation">:</span></span><br><span class="line">  <span class="punctuation">[</span>Nr<span class="punctuation">]</span> Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  <span class="punctuation">[</span> <span class="number">0</span><span class="punctuation">]</span>                   NULL            <span class="number">0000000000000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  <span class="punctuation">[</span> <span class="number">1</span><span class="punctuation">]</span> .text             PROGBITS        <span class="number">0000000000400080</span> <span class="number">000080</span> <span class="number">00000</span>a <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span> <span class="number">16</span></span><br><span class="line">  <span class="punctuation">[</span> <span class="number">2</span><span class="punctuation">]</span> .shstrtab         STRTAB          <span class="number">0000000000000000</span> <span class="number">00008</span>a <span class="number">000011</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line"></span><br><span class="line">Entry point <span class="number">0x400080</span></span><br><span class="line">There is <span class="number">1</span> program header<span class="punctuation">,</span> starting at offset <span class="number">64</span></span><br><span class="line"></span><br><span class="line">Program Headers<span class="punctuation">:</span></span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  LOAD           <span class="number">0x000080</span> <span class="number">0x0000000000400080</span> <span class="number">0x0000000000400080</span> <span class="number">0x00000a</span> <span class="number">0x00000a</span> R E <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"> Section to Segment mapping<span class="punctuation">:</span></span><br><span class="line">  Segment Sections...</span><br><span class="line">   <span class="number">00</span>     .text</span><br></pre></td></tr></table></figure>
<p>By using these steps, we are able to go down to 352 bytes:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">wc</span> noalg-strip</span><br><span class="line">  352 noalg-strip</span><br></pre></td></tr></table></figure>
<h3 id="Custom-linker-script"><a href="#Custom-linker-script" class="headerlink" title="Custom linker script"></a>Custom linker script</h3><p>I think this is a good time to mention that we can create our linker script.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(_start)</span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    . = 0x100e8;    // Set location counter </span><br><span class="line">    .all : &#123;</span><br><span class="line">        *(.text*)   // Pack everything into .all section</span><br><span class="line">    &#125; :code </span><br><span class="line">    .shstrtab : &#123; </span><br><span class="line">       *(.shstrtab) // Explanation below</span><br><span class="line">    &#125;</span><br><span class="line">    /DISCARD/ : &#123;   // Discard all other sections</span><br><span class="line">      *(*)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">PHDRS</span><br><span class="line">&#123;</span><br><span class="line">  code PT_LOAD FILEHDR PHDRS ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>.</code> section is irrelevant to our program, but we need to specify its address so that the linker knows where to put the headers. </p>
<h3 id="shstrtab"><a href="#shstrtab" class="headerlink" title=".shstrtab"></a>.shstrtab</h3><p>While trying to remove the .shstrtab section with <code>objcopy --removesection</code> or with <code>strip -R</code> nothing changed. Likewise, GNU Linker (ld) did not respond to discard this section, it just inserted it. LLVM linker (ld.lld), on the other hand, informs us with the following error message: discarding .shstrtab section is not allowed. </p>
<p>The .shstrtab section is mandatory because the section names are stored as references to this section name table. So as long as there is at least one section in an ELF file, there must be a .shstrtab section.</p>
<p>This allowed us to go down another 8 bytes:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">wc</span> noalg-strip-T-super</span><br><span class="line">  344 noalg-strip-T-super</span><br></pre></td></tr></table></figure>
<h2 id="Why-do-we-need-sections-per-se-then-let’s-try-to-have-some-fun"><a href="#Why-do-we-need-sections-per-se-then-let’s-try-to-have-some-fun" class="headerlink" title="Why do we need sections per se then, let’s try to have some fun."></a>Why do we need sections per se then, let’s try to have some fun.</h2><p><a target="_blank" rel="noopener" href="https://uclibc.org/docs/elf-64-gen.pdf">There</a> is a great document that describes the elf64 structure. We can specify that the ELF header is at offset 0x0 and is 64 bytes, and the Program Header is 56 bytes with offset specified in one of EHDR fields, but preferably after EHDR.</p>
<h3 id="ELF64-Before"><a href="#ELF64-Before" class="headerlink" title="ELF64 Before"></a>ELF64 Before</h3><p><img src="/2024/09/27/3-tiniest-elf/hexyl-before.png" alt="alt text"></p>
<h3 id="EHDR-fields-needed-for-modification"><a href="#EHDR-fields-needed-for-modification" class="headerlink" title="EHDR fields needed for modification"></a>EHDR fields needed for modification</h3><p>The fields we will need to modify in EHDR are:</p>
<ul>
<li>e_entry (Entry point address) now (0x0100f0):<ul>
<li>Specifies where the _start would be; we set it to 0x400080 right next to PHDR</li>
</ul>
</li>
<li>e_shoff (Section Header Offset) now (0x98):<ul>
<li>Specifies the offset to the section header table in the file.</li>
<li>Since we are removing section headers, we set this to 0x0 (no section headers).</li>
</ul>
</li>
<li>e_shentsize (Section Header Entry Size) now (0x40):<ul>
<li>It determines the size of each section header entry.</li>
<li>We set the value to 0x0000 (no section headers).</li>
</ul>
</li>
<li>e_shnum (Number of section header entries) now (0x03):<ul>
<li>This field specifies the number of section header entries.</li>
<li>We set to 0x0000 (no section headers).</li>
</ul>
</li>
<li>e_shstrndx (Section Name String Table Index) now (0x02):<ul>
<li>Specifies the index of the section header string table that contains section names.</li>
<li>Since there are no section headers, we set this value to 0x0 (no string table).</li>
</ul>
</li>
</ul>
<h3 id="PHDR-fields-needed-for-modification"><a href="#PHDR-fields-needed-for-modification" class="headerlink" title="PHDR fields needed for modification"></a>PHDR fields needed for modification</h3><p>The fields we will need to modify in PHDR are:</p>
<ul>
<li>p_offset (Offset in the file) now (0x0):<ul>
<li>This represents where the segment starts in the file. We will have only one segment with a code, we set it to 0x80</li>
</ul>
</li>
<li>p_vaddr (Virtual address in memory):<ul>
<li>This is where the segment will be loaded into memory. You can choose a reasonable virtual address, typically aligned, like 0x400080 (just after the headers, matching the p_offset).</li>
</ul>
</li>
<li>p_paddr (Physical address):<ul>
<li>This is generally ignored for most modern systems, so you can either mirror p_vaddr or set it to 0x0.</li>
</ul>
</li>
<li>p_filesz (Size of the segment in the file):<ul>
<li>This should be the size of the code segment you’re keeping, not including the ELF header or program header.</li>
<li>For instance, our code is 10 bytes, we set this to 0xA.</li>
</ul>
</li>
<li>p_memsz (Size of the segment in memory):<ul>
<li>This should match p_filesz if the segment size in memory is the same as the file size (which is typical for a simple executable).</li>
<li>The code size is 10 bytes, we set this to 0xA.</li>
</ul>
</li>
</ul>
<p>We can delete everything that is after our code. </p>
<h3 id="Final-result"><a href="#Final-result" class="headerlink" title="Final result"></a>Final result</h3><p><img src="/2024/09/27/3-tiniest-elf/hexyl-after.png" alt="alt text"><br>I edited the values using ghex, saved the file. The system has no idea it is an elf64 file and is executable, so we add a flag with the <code>chmod +x</code> command. And we can check if the program works as intended and check the size:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./noalg-strip-T-super-PH-align ; <span class="built_in">echo</span> $?</span><br><span class="line">  1</span><br><span class="line">$ <span class="built_in">wc</span> noalg-strip-T-super-PH-align</span><br><span class="line">  138 noalg-strip-T-super-PH-align</span><br></pre></td></tr></table></figure>
<h3 id="Removing-alignment"><a href="#Removing-alignment" class="headerlink" title="Removing alignment"></a>Removing alignment</h3><p>This is already very good, recall that EHDR 64 + PHDR 56 &#x3D; 110 with code + 10 &#x3D; 130. Why the remaining 8. That’s because we still did not get rid of alignment.</p>
<p>We have to change: </p>
<ul>
<li>e_entry</li>
<li>p_offset</li>
<li>p_vaddr</li>
<li>p_paddr</li>
<li>p_align (Alignment of the segment) now(0x10):<ul>
<li>For minimal alignment, we can use 0x1.</li>
</ul>
</li>
</ul>
<p><img src="/2024/09/27/3-tiniest-elf/hexyl-noalign.png" alt="alt text"></p>
<h2 id="Reducing-instruction-size"><a href="#Reducing-instruction-size" class="headerlink" title="Reducing instruction size"></a>Reducing instruction size</h2><p>Now we have only EHDR, PHDR and code, it’s 130 bytes. It’s always the case that if you think something is close to being over, you’re probably halfway through something that someone has already figured out. In computer science, this is a common feeling. So too in this case, still this file can be reduced. It’s not surprising that we can select the exact instructions that have as few bytes as possible in optcode.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Old code</span></span><br><span class="line"><span class="number">66</span> b8 <span class="number">3</span>c <span class="number">00</span>   mov    ax<span class="punctuation">,</span><span class="number">0x3c</span></span><br><span class="line"><span class="number">66</span> bf <span class="number">01</span> <span class="number">00</span>   mov    di<span class="punctuation">,</span><span class="number">0x1</span></span><br><span class="line"><span class="number">0</span>f <span class="number">05</span>         syscall</span><br><span class="line"></span><br><span class="line"><span class="comment">// New code</span></span><br><span class="line"><span class="number">31</span> ff         xor    edi<span class="punctuation">,</span>edi</span><br><span class="line"><span class="number">6</span>a <span class="number">3</span>c         push   <span class="number">0x3c</span></span><br><span class="line"><span class="number">58</span>            pop    rax</span><br><span class="line"><span class="number">0</span>f <span class="number">05</span>         syscall</span><br></pre></td></tr></table></figure>
<p>Just by changing instructions, we are able to cut 3 bytes. Fun fact <code>xor di, di</code> and <code>xor rdi, rdi</code> are 3 bytes, <code>xor edi, edi</code> is the best 2-byte choice. The mov instructions are very expensive, so it makes sense to replace them with a stack. Here it is similar, pop rax is the best choice over other parts of this register.<br><img src="/2024/09/27/3-tiniest-elf/hexyl-noalign-instruction.png" alt="alt text"></p>
<h2 id="Embedding-the-Code-in-the-ELF-Header"><a href="#Embedding-the-Code-in-the-ELF-Header" class="headerlink" title="Embedding the Code in the ELF Header"></a>Embedding the Code in the ELF Header</h2><p>The ELF64 format does not define where the code and even the Program Header should be. As you can see, of the 16 bytes of the EHDR header, as many as 8 bytes are unused. This is the perfect place to fit our code!<br><img src="/2024/09/27/3-tiniest-elf/hexyl-noalign-instruction-embed.png" alt="alt text"><br>Now we are at 120 bytes and of course while calling <code>readelf -a</code> we will see our code:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -lSaW shortest</span><br><span class="line">  ELF Header<span class="punctuation">:</span></span><br><span class="line">    Magic<span class="punctuation">:</span>   <span class="number">7</span>f <span class="number">45</span> <span class="number">4</span>c <span class="number">46</span> <span class="number">02</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span> <span class="number">31</span> ff <span class="number">6</span>a <span class="number">3</span>c <span class="number">58</span> <span class="number">0</span>f <span class="number">05</span> <span class="number">00</span></span><br><span class="line">    Class<span class="punctuation">:</span>                             ELF64</span><br></pre></td></tr></table></figure>
<p>but it’s not a problem for readelf to define that it’s ELF64 file.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Delving into the alignment mechanism allowed us to see what memory sacrifices are used today to achieve speed. This could not have happened at once; over the years, as technology progressed, the capacity of specific memories increased, and speed sacrifices may have been made. The techniques presented in this article are more of a curiosity than a guide. Rarely is such a reduction in executable file size needed these days. </p>
<h3 id="During-the-writing-thoughts"><a href="#During-the-writing-thoughts" class="headerlink" title="During the writing thoughts"></a>During the writing thoughts</h3><p>I had a hard time sensing a line anywhere where I should describe something more broadly and discuss it in detail; I apparently have yet to sense the target audience. Often, too, when exploring a topic and going down with an article, I had to go back up, reworking it after gaining a broader perspective. I’m not sure if the article didn’t come out too long, I had the thought of breaking it into two parts.</p>
<h2 id="What-next"><a href="#What-next" class="headerlink" title="What next?"></a>What next?</h2><p>In this article I used the expressions “process” and “program” quite interchangeably, in this context it did not have a tremendous meaning, but it will gain importance in my next article in which I will discuss how threads are created, what is clone() fork() execve() or pthread_create().</p>
<details>
<summary><span style="color:rgb(0, 152, 241)">Sources</span></summary>

<ul>
<li><a target="_blank" rel="noopener" href="https://uclibc.org/docs/elf-64-gen.pdf">https://uclibc.org/docs/elf-64-gen.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://lld.llvm.org/">https://lld.llvm.org/</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/39960434/linux-elf-file-sections-name">https://stackoverflow.com/questions/39960434/linux-elf-file-sections-name</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/65719528/why-is-shstrtab-section-mandatory">https://stackoverflow.com/questions/65719528/why-is-shstrtab-section-mandatory</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31453859/how-to-remove-a-specific-elf-section-without-stripping-other-symbols">https://stackoverflow.com/questions/31453859/how-to-remove-a-specific-elf-section-without-stripping-other-symbols</a></li>
<li><a target="_blank" rel="noopener" href="https://hackmd.io/@brlin/orncb-ld-manual/https%3A%2F%2Fsourceware.org%2Fbinutils%2Fdocs-2.32%2Fld%2FLocation-Counter.html">https://hackmd.io/@brlin/orncb-ld-manual/https%3A%2F%2Fsourceware.org%2Fbinutils%2Fdocs-2.32%2Fld%2FLocation-Counter.html</a></li>
<li>Andrew S. Tanenbaum - Modern Operating Systems</details></li>
</ul>

  </div>
</article>
<div class="social-buttons-container">
    
        <div class="button-wrapper">
            <button class="terminal-button" onclick="window.open('https://www.linkedin.com/newsletters/low-level-tech-articles-7249831254945107969', '_blank')">
                [Subscribe Newsletter]
            </button>
            <button class="terminal-button" onclick="window.open('www.linkedin.com/comm/mynetwork/discovery-see-all?usecase=PEOPLE_FOLLOWS&amp;followMember=dawidgraabowski', '_blank')">
                [Connect with me on LinkedIn]
            </button>
        </div>
    
</div>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/dxrgrabowski">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Preface"><span class="toc-number">1.</span> <span class="toc-text">Preface</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#C-specifics"><span class="toc-number">1.1.</span> <span class="toc-text">C specifics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Glibc"><span class="toc-number">1.2.</span> <span class="toc-text">Glibc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-this-could-differ-to-other-pc"><span class="toc-number">1.3.</span> <span class="toc-text">How this could differ to other pc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Intel-vs-AT-T-syntax"><span class="toc-number">1.4.</span> <span class="toc-text">Intel vs AT&amp;T syntax</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-steps-we-can-make-in-C-to-reduce-file-size"><span class="toc-number">2.</span> <span class="toc-text">What steps we can make in C to reduce file size</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Assembly"><span class="toc-number">3.</span> <span class="toc-text">Assembly</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memory-Alignment-in-Sections-and-Segments"><span class="toc-number">4.</span> <span class="toc-text">Memory Alignment in Sections and Segments</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Modifying-and-removing-alignment"><span class="toc-number">4.1.</span> <span class="toc-text">Modifying and removing alignment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Custom-linker-script"><span class="toc-number">4.2.</span> <span class="toc-text">Custom linker script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shstrtab"><span class="toc-number">4.3.</span> <span class="toc-text">.shstrtab</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-do-we-need-sections-per-se-then-let%E2%80%99s-try-to-have-some-fun"><span class="toc-number">5.</span> <span class="toc-text">Why do we need sections per se then, let’s try to have some fun.</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ELF64-Before"><span class="toc-number">5.1.</span> <span class="toc-text">ELF64 Before</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EHDR-fields-needed-for-modification"><span class="toc-number">5.2.</span> <span class="toc-text">EHDR fields needed for modification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHDR-fields-needed-for-modification"><span class="toc-number">5.3.</span> <span class="toc-text">PHDR fields needed for modification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Final-result"><span class="toc-number">5.4.</span> <span class="toc-text">Final result</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Removing-alignment"><span class="toc-number">5.5.</span> <span class="toc-text">Removing alignment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reducing-instruction-size"><span class="toc-number">6.</span> <span class="toc-text">Reducing instruction size</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Embedding-the-Code-in-the-ELF-Header"><span class="toc-number">7.</span> <span class="toc-text">Embedding the Code in the ELF Header</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">8.</span> <span class="toc-text">Conclusion</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#During-the-writing-thoughts"><span class="toc-number">8.1.</span> <span class="toc-text">During the writing thoughts</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-next"><span class="toc-number">9.</span> <span class="toc-text">What next?</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&text=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&title=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&is_video=false&description=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=The Art of Creating Minimal ELF64 Executables by Unconventional Methods&body=Check out this article: http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&title=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&title=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&title=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&title=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&name=The Art of Creating Minimal ELF64 Executables by Unconventional Methods&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://dxrgrabowski.github.io/2024/09/27/3-tiniest-elf/&t=The Art of Creating Minimal ELF64 Executables by Unconventional Methods"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    Dawid Grabowski
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/dxrgrabowski">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'dxrgrabowski/dxrgrabowski.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
